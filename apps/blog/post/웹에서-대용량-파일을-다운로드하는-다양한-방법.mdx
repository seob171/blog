---
title: ì›¹ì—ì„œ ëŒ€ìš©ëŸ‰ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•
summary: ìŠ¤í†¡ ì˜ìƒì„ ë¶„í•  ë‹¤ìš´ë¡œë“œ í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì‚½ì§ˆê¸°
publishedAt: 2024.10.15
---

ì–´ëŠ ë‚ , ìŠ¤í†¡ì˜ìƒì´ ë‹¤ìš´ë¡œë“œ ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” csê°€ ë“¤ì–´ì™”ë‹¤.

ìœ ì €ê°€ ë‹¤ìš´ë¡œë“œ í•œ íŒŒì¼ì„ í™•ì¸í•´ë³´ë‹ˆ 1ë¶„ì´ ë„˜ëŠ” ê¸¸ì´ì— 4k í™”ì§ˆë¡œ ìš©ëŸ‰ì´ ê½¤ í° í¸ì´ì˜€ë‹¤.

ê¸°ì¡´ ë‹¤ìš´ë¡œë“œ ë°©ì‹ì€ ì•„ë˜ì™€ ê°™ì•˜ë‹¤.
```typescript
const response = await fetch('file-url');
const reader = response.body.getReader();
let chunks = [];
let receivedLength = 0;

while(true) {
    const {done, value} = await reader.read();
    if (done) break;
    chunks.push(value); // Chunkë“¤ì„ ë°°ì—´ì— ëˆ„ì 
    receivedLength += value.length; // ëˆ„ì ëœ ê¸¸ì´ ê³„ì‚°
}

// ëˆ„ì ëœ chunksë¥¼ í•©ì³ì„œ íŒŒì¼ë¡œ ì²˜ë¦¬
let blob = new Blob(chunks);
```

ì›ì¸ì€ ê¸°ì¡´ ë‹¤ìš´ë¡œë“œê°€ Blob í˜•íƒœì˜€ëŠ”ë°, Blobì€ InMemory ë°©ì‹ì´ë¼, íŒŒì¼ í¬ê¸°ê°€ ë©”ëª¨ë¦¬(RAM)ë³´ë‹¤ í° ê²½ìš° ì˜ˆì™¸ ìƒí™©ì´ ë°œìƒí•˜ëŠ” ê²ƒì´ì˜€ë‹¤.

ë™ë£Œê°€ ë¦¬ì„œì¹˜í•œ 3ê°€ì§€ ì •ë„ ë°©ì•ˆì´ ìˆì—ˆëŠ”ë°,
1. Stream ì²˜ë¦¬
2. multipart download > [s3 using large file scenario docs](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/example_s3_Scenario_UsingLargeFiles_section.html)
3. window [showSaveFilePicker](https://developer.mozilla.org/en-US/docs/Web/API/Window/showSaveFilePicker)


2ë²ˆì˜ ê²½ìš° objectì˜ ì •í™•í•œ ë””ë ‰í† ë¦¬ ìœ„ì¹˜ë¥¼ ì „ë‹¬í•˜ëŠ” ë°©ì‹ì´ í•„ìš”í–ˆëŠ”ë°, í˜„ì¬ ì‚¬ìš©í•˜ëŠ” urlì´ ë³´ì•ˆì„ ì¶”êµ¬í•˜ëŠ” preSignedUrlì´ë¼ ë§ì§€ì•Šì•˜ê³ 
3ë²ˆì˜ ê²½ìš° safariëŠ” ë¯¸ì§€ì›í•˜ê¸° ë•Œë¬¸ì— 1ë²ˆ Stream ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤.

ë‹¤ë§Œ ë¸Œë¼ìš°ì € nativeì˜ streamì€ ì œì•½ì´ ë§ì€ë°, ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ í•´ë‹¹ ì´ìŠˆë¥¼ ê°œì„ í•˜ê¸°ì—” íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ëŠ”ê²Œ í•©ë¦¬ì ì´ë¼ íŒë‹¨ë˜ì–´ [FileSaver](https://www.npmjs.com/package/file-saver)ë¥¼ extendsí•œ [streamsaver](https://github.com/jimmywarting/StreamSaver.js)ë¥¼ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆë‹¤.

ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ê°€ 2-3ë…„ ì „ì´ë¼ëŠ”ê²Œ ìº¥ê¸°ê¸´ í–ˆì§€ë§Œ starë¥¼ ë§ì´ ë°›ì•˜ê³  ê´€ë ¨ ë‚´ìš©ë„ ë§ì•„ì„œ íƒ€í˜‘í•˜ê¸°ë¡œ í–ˆë‹¤

---

## Streamsaver

íŒ¨í‚¤ì§€ ì„¤ì¹˜ í›„ ëŒ€ëµ ì•„ë˜ì™€ ê°™ì´ ì‘ì—…í•´ì„œ fetchí•  urlê³¼ filenameì„ ì „ë‹¬ë°›ëŠ” hookì„ êµ¬í˜„í•´ì„œ ë‹¤ìš´ë¡œë“œ í•˜ëŠ”ê³³ì— ì—°ê²°í•˜ì˜€ë‹¤.

```typescript
import {createWriteStream} from 'streamsaver'
// ...
const res = await fetch(url, { signal: abortController.current.signal });
const readableStream = res.body;
const fileStream = createWriteStream(filename);
// ...
if (window.WritableStream) {
    return readableStream
        .pipeThrough(progress, { signal: abortController.current?.signal })
        .pipeTo(fileStream, { signal: abortController.current?.signal })
        .then(() => {
            setStatus('done');
            onSuccess?.();
        })
        .catch((err) => {
            onError?.(err);
            setStatus('error');
        });
}

const writer = fileStream.getWriter();

const reader = res.body?.getReader();
const pump = () => {
    reader
        ?.read()
        .then((res) => (res.done ? writer.close() : writer.write(res.value).then(pump)))
        .catch((err) => {
            onError?.(err);
            setStatus('error');
        });
};

pump();

```

ë¬¸ì œê°€ ì—†ì—ˆë‹¤. ì •ìƒ ë™ì‘í–ˆì—ˆë‹¤

<video src="/videos/CleanShot%202024-10-16%20at%2000.04.11.mp4" controls width="400px" />

ë¬¸ì œê°€ ì—†ì—ˆë‹¤ê³  ìƒê°í–ˆëŠ”ë°, ì‚¬íŒŒë¦¬ì—ì„  ë™ì‘í•˜ì§€ ì•Šì•˜ë‹¤.

í´ë¦¬í•„ì´ ë¬¸ì œì¼ê¹Œ ìƒê°í•´ì„œ êµ¬ê¸€ë§í•œëŒ€ë¡œ [web-streams-polyfill](https://www.npmjs.com/package/web-streams-polyfill)ë„ ì„¤ì¹˜í•´ë´¤ë‹¤.

ê·¸ëŸ¬ë‚˜ ë™ì‘í•˜ì§€ ì•Šì•˜ë‹¤.

ê²°êµ­ì—” íŒ¨í‚¤ì§€ì— ë¬¸ì œê°€ ìˆë‹¤ê³  íŒë‹¨ ~~(2ë…„ë„˜ê²Œ ì—…ë°ì´íŠ¸ê°€ ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸..?)~~ í•˜ì—¬ íŒ¨í‚¤ì§€ ì—†ì´ ì§ì ‘ êµ¬í˜„í•´ë³´ê¸°ë¡œ í–ˆë‹¤.

[Stream Api](https://developer.mozilla.org/en-US/docs/Web/API/Streams_API)ë¥¼ ì°¾ì•„ë³´ê³  ì—¬ëŸ¬ ì‹œí–‰ì°©ì˜¤ ëì— `reader`ì™€ `writer` / `pipeThrough`ì™€ `pipeTo`ì— ëŒ€í•´ ì ì  ì´í•´ê°€ ëë‹¤.


```typescript
const response = await fetch('file-url');
const reader = response.body.getReader();
const stream = new WritableStream({
    write(chunk) {
        // ê° chunkë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì €ì¥í•˜ê±°ë‚˜ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬processChunk(chunk); // ì˜ˆì‹œ í•¨ìˆ˜ë¡œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì²˜ë¦¬
    }
});

response.body.pipeTo(stream);
```

ê·¸ëŸ¬ë‚˜ ì´ ë˜í•œ `write(chunk)` ë¥¼ í•˜ê³  ë‚œ ë‹¤ìŒ ì–´ë–»ê²Œ í•´ì•¼í•  ì§€ ì•Œìˆ˜ê°€ ì—†ì—ˆë‹¤.
êµ¬ê¸€ë§ë„ gptë„ í•´ë³´ë‹ˆ íŒ¨í‚¤ì§€ ì—†ì´ í´ë¼ì´ì–¸íŠ¸ë‹¨ì—ì„œë§Œ Stream ë‹¤ìš´ë¡œë“œë¥¼ êµ¬í˜„í•˜ê¸°ëŠ” ì–´ë µê³  `Service Worker`ë‚˜ `node(ì„œë²„)`ë¥¼ ê°™ì´ ì‚¬ìš©í•´ì•¼ í•œë‹¤ê³  í–ˆë‹¤.

ìš°ì„  next.jsë¥¼ ì‚¬ìš©í•˜ë‹ˆ ì„œë²„ë¥¼ í™œìš©í•˜ê¸°ë¡œ í–ˆë‹¤. app routerì— ë§ê²Œ ìˆ˜ì •ì„ í–ˆëŠ”ë°, ì´ ë°©ë²•ë„ stream í˜•ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ í•  ìˆ˜ëŠ” ì—†ì—ˆë‹¤.

[ì œë¡œì´ˆë‹˜ì˜ ì°¸ê³ ë¬¸ì„œ](https://www.zerocho.com/category/NodeJS/post/60778f07cf47fe0004727b12)

[ê°œë°œì ë¸”ë¡œê·¸ ì°¸ê³ ë¬¸ì„œ](https://www.codeconcisely.com/posts/nextjs-app-router-api-download-file/)

[Stream Data ë¬¸ì„œ](https://dev.to/bsorrentino/how-to-stream-data-over-http-using-nextjs-1kmb)

ì´ëŸ¬í•œ ì—¬ëŸ¬ ì°¸ê³ ìë£Œë¥¼ ë³´ë‹¤ê°€ stream api ê´€ë ¨ ë³´ë‹¤ëŠ” large fileì„ ì–´ë–»ê²Œ ì›¹ì—ì„œ ë‹¤ìš´ë¡œë“œ í•˜ëŠ”ì§€ë¥¼ ì°¾ì•„ë´¤ëŠ”ë°,


[upload-and-download-files-using-presigned-urls](https://medium.com/@alexefimenko/building-s3-file-storage-with-next-js-4-upload-and-download-files-using-presigned-urls-a83207f48227) ì„ ë°œê²¬í–ˆë‹¤.

---

## Presigned URLs

<img src="/assets/CleanShot%202024-10-16%20at%2000.44.39%402x.png" width="100%" height="auto" alt="presigned URLì„ ì‚¬ìš©í•´ì„œ ë‹¤ìš´ë¡œë“œ í•˜ëŠ” ë°©ë²•" />


s3 > `presigned URL`ì„ ì‚¬ìš©í•´ì„œ ë‹¤ìš´ë¡œë“œ í•  ìˆ˜ ìˆë‹¤ëŠ” ë‚´ìš©ì„ ì°¾ê²Œë˜ì—ˆë‹¤.

`presigned URL`ì´ë€ ë§ ê·¸ëŒ€ë¡œ ë¯¸ë¦¬ ì„œëª…í•œ urlì´ë€ ëœ»ìœ¼ë¡œ ë¯¸ë¦¬ ì¼ì •ì‹œê°„ë™ì•ˆ ê¶Œí•œì´ë‚˜ ì˜µì…˜ì„ ë¶€ì—¬í•œ urlì´ë‹¤

ìš°ë¦¬ëŠ” ê¸°ì¡´ì— presignedUrlì„ ì‚¬ìš©ì¤‘ì´ì˜€ê³  `window.open(presignedUrl,'_self')` ë¥¼ ì‹¤í–‰í•˜ë‹ˆ ìƒê°í•œëŒ€ë¡œì˜ ë¶„í•  ë‹¤ìš´ë¡œë“œê°€ ë™ì‘í–ˆë‹¤!!

ê·¸ëŸ¬ë‚˜ mov íŒŒì¼ì€ ë‹¤ìš´ë¡œë“œê°€ ì˜ ëëŠ”ë°, mp4íŒŒì¼ì€ ìƒˆíƒ­ìœ¼ë¡œ ì—´ë¦¬ëŠ” ë¬¸ì œê°€ ìˆì—ˆë‹¤.

ê´€ë ¨í•´ì„œ ì°¾ì•„ë³´ë‹ˆ 


> ê¸°ë³¸ MIME íƒ€ì… ì²˜ë¦¬ ë°©ì‹ ë•Œë¬¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ëŠ” í™•ì¥ìì— ë”°ë¼ íŒŒì¼ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€ ê²°ì •í•˜ëŠ”ë°, .mp4ëŠ” ëŒ€ë¶€ë¶„ì˜ ë¸Œë¼ìš°ì €ì—ì„œ ì¬ìƒ ê°€ëŠ¥í•œ í˜•ì‹ìœ¼ë¡œ ê°„ì£¼ë˜ì–´ ìƒˆ íƒ­ì—ì„œ ì—´ë¦¬ì§€ë§Œ, .mov íŒŒì¼ì€ ê¸°ë³¸ì ìœ¼ë¡œ ë¯¸ë””ì–´ í”Œë ˆì´ì–´ë¡œ ì—°ë™ë˜ê±°ë‚˜ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.
> ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œ, ì„œë²„ì—ì„œ ì œê³µí•˜ëŠ” íŒŒì¼ì˜ Content-Disposition í—¤ë”ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¼ê³  ë‚˜ì™€ì„œ nextjs ë¡œ êµ¬í˜„ëœ ì„œë²„ë¥¼ ê¹Œë³´ë‹ˆ `presigned URL`ì„ ìƒì„±í•˜ëŠ” ë¡œì§ì´ ìˆì—ˆëŠ”ë° `Content-Disposition` ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šì•˜ë‹¤.

```typescript
async createGetPresignedUrl(
    // ...args
): Promise<string> {
    const command = new GetObjectCommand({
        Bucket: this.AWS_BUCKET,
        // ...
        ResponseContentDisposition:`attachment;filename="${filename}"`,
    })
    // ...
}
```

ë‹¤ìŒê³¼ ê°™ì´ `ResponseContentDisposition`ë¥¼ ì„¤ì •í•˜ì—¬ urlì„ ìƒì„±í•˜ë‹ˆ mp4íŒŒì¼ë„ ì •ìƒì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œê°€ ëë‹¤!!

---

### ê·¸ëŸ°ë°,
ê²€ì¦ê³¼ì •ì—ì„œ ì˜ˆê¸°ì¹˜ ëª»í•œ ì´ìŠˆë¥¼ ë°œê²¬í–ˆëŠ”ë°, í•œê¸€ì´ í¬í•¨ëœ filenameì˜ ê²½ìš° ì…ë ¥í•œ ê°’ì´ ì•„ë‹Œ ë””ì½”ë”©ëœ ì´ë¦„ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œê°€ ëë‹¤.

ê·¸ë˜ì„œ `encodeURI`ë¥¼ ì²˜ë¦¬í•˜ì˜€ë‹¤. í”„ë¡ íŠ¸ë‚˜ ë°±ì—ì„œ ì¸ì½”ë”©ì„ ì²˜ë¦¬í•´ì£¼ë©´ ëœë‹¤.

```typescript
async createGetPresignedUrl(
    // ...args
): Promise<string> {
    
    const encodedFilename = encodeURI(filename);
    
    const command = new GetObjectCommand({
        Bucket: this.AWS_BUCKET,
        // ...
        ResponseContentDisposition:`attachment;filename="${encodedFilename}"`,
    })
    // ...
}
```

ìš´ì˜ì¤‘ì¸ ìŠ¤í†¡ ì„œë¹„ìŠ¤ëŠ” ì‚¬íŒŒë¦¬ë„ ì§€ì›í–ˆëŠ”ë°, `Header value cannot be represented using ISO-8859-1` ë¼ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ì„œ ì •ìƒì ìœ¼ë¡œ íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ë˜ì§€ì•Šì•˜ë‹¤. ğŸ¤¬

gptì—ê²Œ ë¬¼ì–´ë³´ë‹ˆ ì¹œì ˆí•˜ê²Œ ë‹µì„ ì•Œë ¤ì£¼ì—ˆë‹¤.

> "Header value cannot be represented using ISO-8859-1"ë¼ëŠ” ì—ëŸ¬ëŠ” HTTP í—¤ë”ì—ì„œ ì‚¬ìš©ëœ ê°’ì´ ISO-8859-1 ë¬¸ì ì¸ì½”ë”©ìœ¼ë¡œ í‘œí˜„ë  ìˆ˜ ì—†ì„ ë•Œ ë°œìƒí•©ë‹ˆë‹¤. ISO-8859-1ì€ ëŒ€ë¶€ë¶„ì˜ ì„œêµ¬ ì–¸ì–´ì—ì„œ ì‚¬ìš©ë˜ëŠ” 8ë¹„íŠ¸ ë¬¸ì ì¸ì½”ë”©ì´ì§€ë§Œ, í•œê¸€ì´ë‚˜ ë‹¤ë¥¸ ë¹„ì„œêµ¬ê¶Œ ë¬¸ìë“¤(ì˜ˆ: ì¼ë³¸ì–´, ì¤‘êµ­ì–´) ë˜ëŠ” ì´ëª¨ì§€ì™€ ê°™ì€ íŠ¹ìˆ˜ ë¬¸ìëŠ” ì´ ì¸ì½”ë”©ìœ¼ë¡œ í‘œí˜„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ìµœì¢…ì ìœ¼ë¡œ presignedUrlë¥¼ ë°œê¸‰ë°›ëŠ” ì½”ë“œê°€ ì™„ì„±ëë‹¤.

```typescript

async function getPresignedUrl(bucketName, objectKey) {
    // íŒŒì¼ëª…ì„ URI ì¸ì½”ë”© (UTF-8ë¡œ ì¸ì½”ë”©)
    const filename = 'DropshotStock_UP6WFW1U_ì•ˆê²½ì„ ë¼ê³  í´ë¦½ë³´ë“œì— ë¬´ì–¸ê°€ë¥¼ ì ëŠ” ê¸´ ë¨¸ë¦¬ ì—¬ì„±_preview.mov';
    const encodedFilename = encodeURIComponent(filename);

    const command = new GetObjectCommand({
        Bucket: bucketName,
        Key: objectKey,
        ResponseContentDisposition: `attachment; filename*=UTF-8''${encodedFilename}`,  // filename*ì„ ì‚¬ìš©í•˜ì—¬ UTF-8 ì¸ì½”ë”©ëœ íŒŒì¼ëª… ì„¤ì •
    });

    try {
        const presignedUrl = await getSignedUrl(s3Client, command, { expiresIn: 3600 });
        return presignedUrl;
    } catch (err) {
        //...
    }
}
```

<video src="/videos/CleanShot%202024-10-19%20at%2001.20.23.mp4" controls width="100%" height="auto" />

---

ì—¬ëŸ¬ ì‹œí–‰ì°©ì˜¤ê°€ ìˆì—ˆì§€ë§Œ, ì‚½ì§ˆí•˜ëŠ” ê³¼ì •ì—ì„œ stream apiì— ëŒ€í•´ì„œë„ ì•Œê²Œë˜ì—ˆê³ , s3ì˜ presigned URLë„ í•™ìŠµí•  ê¸°íšŒê°€ ìˆì—ˆë‹¤.
